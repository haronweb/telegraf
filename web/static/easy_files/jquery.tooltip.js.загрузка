/*
 * jQuery Tooltip plugin 1.0
 *
 * Copyright (c) 2011 Balakirev Anatoliy
 *
 *
 * Licensed under the MIT license:
 *   http://www.opensource.org/licenses/mit-license.php
 */
(function ($) {

  var tooltipContainer, // Link to the container of the tooltips.
          tooltipBody, // Link to the body of the tooltip.
          showTimeoutId, // Timeout id for delayed showing of the tooltip.
          hideTimeoutId;// Timeout id for delayed hiding of the tooltip .

  $.tooltip = {
    defaults:{
      showDelay:140, // Delay for showing tooltip
      extraClass:"", // Additional class, which will be added to the tooltip container
      left:0, // Additional adjustment for "left" parameter
      top:-22, // Additional adjustment for "top" parameter
      adjustToFitWindow:true, // Is tooltip must be adjusted if it doesn`t fit into the visible window area
      getContent:function () { // Function, which returns content, which will be used for tooltip
        return "";
      }
    }
  };

  $.fn.extend({
    tooltip:function (settings) {
      settings = $.extend({}, $.tooltip.defaults, settings);

      if (!tooltipContainer) {  // We need only one tooltip container.
        // Create container, append it to document and hide.
        tooltipContainer = $('<div id="tooltip" style="z-index: 1000;"><div class="body"></div></div>').appendTo(document.body).hide();

        // Save reference to the tooltip body for further usages.
        tooltipBody = $('div.body', tooltipContainer);
      }

      return this.each(
              function () {
                this.settings = settings;
                var $this = this;
                tooltipContainer.mouseover(
                        function () {
                          cancelHiding();
                        }
                ).mouseout(
                        function () {
                          hide.apply($this);
                        }
                );
              }
      ).mouseover(
              function () {
                cancelHiding();
                initialize.apply(this);
              }
      ).mouseout(
              function () {
                hide.apply(this);
              }
      );
    }
  });

  function initialize() {
    var settings = this.settings;
    /*-----------------------------Setting content----------------------------*/
    var bodyContent = settings.getContent.call(this);
    tooltipBody.html(bodyContent);
    // add an optional class for this tip
    tooltipContainer.removeClass().addClass(settings.extraClass);
    /*-----------------------------Setting content----------------------------*/

    /*---------------------------Updating position----------------------------*/
    var position = $(this).offset();

    position.left += $(this).outerWidth();
    position.top += $(this).outerHeight();

    // Add adjustments for "x" and "y" specified by user.
    position.left += settings.left;
    position.top += settings.top;


    /*---Normalize position of the tooltip if it`s out of screen`s borders.---*/
    if (settings.adjustToFitWindow) {
      // Check if right corner of tooltip is out of screen
      var availableWindowWidth = ($(window).scrollLeft() + $(window).width());
      if (availableWindowWidth < (position.left + $(tooltipContainer).outerWidth())) {
        var adjustedLeft = (position.left - ($(tooltipContainer).outerWidth() + $(this).outerWidth() + settings.left));
        // If adjusted left is not out of screen - apply it.
        if (adjustedLeft >= $(window).scrollLeft()) {
          position.left = adjustedLeft;
        } else {
          // At this point we know, that tooltip doesn`t fit into the window as
          // from the right of the link as and from the left. So now let`s try
          // to move it to the left not for its width, but for the width, which
          // doesn`t fit from the right.
          position.left = (position.left + $(tooltipContainer).outerWidth()) - availableWindowWidth;
          // If we had additional "top-adjustment" from the settings - we have
          // to remove it in this case.
          position.top -= settings.top;
        }
      }

      // Check if bottom corner of tooltip is out of screen
      var availableWindowHeight = ($(window).scrollTop() + $(window).height());
      if (availableWindowHeight < (position.top + $(tooltipContainer).outerHeight())) {
        var adjustedTop = (position.top - ($(tooltipContainer).outerHeight() + $(this).outerHeight() + settings.top));
        // If adjusted top is not out of screen - apply it.
        if (adjustedTop >= $(window).scrollTop()) {
          position.top = adjustedTop;
        }
      }
    }
    /*---Normalize position of the tooltip if it`s out of screen`s borders.---*/

    tooltipContainer.css({top:position.top + 'px', left:position.left + 'px'});
    /*---------------------------Updating position----------------------------*/


    // Showing tooltip.
    if (settings.showDelay) {
      showTimeoutId = setTimeout(function () {
        tooltipContainer.show();
      }, settings.showDelay);
    } else {
      tooltipContainer.show();
    }
  }

  function hide() {
    if (hideTimeoutId) {
      return;// Hiding has been already started.
    }
    hideTimeoutId = setTimeout(function () {
      clearTimeout(showTimeoutId);
      tooltipContainer.hide();
    }, 100);
  }

  function cancelHiding() {
    clearTimeout(hideTimeoutId);
    hideTimeoutId = null;
  }


})(jQuery);