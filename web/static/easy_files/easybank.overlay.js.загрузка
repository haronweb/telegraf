
(function( $) {
	function Overlay() {
		this._target_holder;
        this._fullsize;
        this._loadingImgAngle = 0;
        this._withImageAnimation = false;
        this._animationDuration = 1500;
        this._animationInterval;
        this._isIE = ($.browser.msie == true);
	}

	$.extend(Overlay.prototype, {
		_attachListeners : function() {
			//$('.close-overlay, .close-overlay_header, .close-it, .pp_overlay, #overlay-content-1 .wrap-btn').bind('click', function() {
			$('.close-overlay, .close-overlay_header, .close-it, #overlay-content-1 .wrap-btn').bind('click', function() {
				$.overlay.close();
			});
		},
		
		close : function() {
            $('div.pp_overlay, ' + this._target_holder)
                    .add('div.pp_overlay_header, ' + this._target_holder)
                    .add('div.ppt, ' + this._target_holder)
                    .hide().css('visibility','hidden');

            if (this._withImageAnimation && !this._isIE) {
              window.clearInterval(this._animationInterval);
            }
          if (isIE6) $("select").css('visibility','visible');//added for IE6 support
		},
		
		show : function() {
            $('div.pp_overlay, ' + this._target_holder)
                    .add('div.pp_overlay_header, ' + this._target_holder)
                    .add('div.ppt, ' + this._target_holder)
                    .show().css('visibility','visible');

            if (this._withImageAnimation && !this._isIE) {
              var self = this;
              self._startRotateImage();
              this._animationInterval = window.setInterval(function() {
                self._startRotateImage();
              }, (this._animationDuration + 100));
            }
            if (isIE6) $("select").css('visibility','hidden');//added for IE6 support
		},

        _startRotateImage : function() {
          return;
          var self = this;
          this._loadingImgAngle += 360;

          $('#overlay-loading img').rotate({
            animateTo : this._loadingImgAngle,
            duration: self._animationDuration
          });
        },
		
		_buildOverlay : function(){
            var toInject = "";
			
			// Build the background overlay div
            if ($(".pp_overlay").size() == 0) {
              toInject += '<div class="pp_overlay"></div>';
            }
			
			// Basic html for the title holder
            if ($(".ppt").size()==0)
			    toInject += '<div class="ppt"></div>';

            if (toInject!="")
			    $('body').append(toInject);
			
			// So it fades nicely
			$('div.pp_overlay').hide().css('opacity',0.4);
			$('div.ppt').hide().css({
				'opacity' : 0,
				'background' : '#FFFFFF'
			});
			
			// Set my global selectors
			$pp_pic_holder = $('.pp_pic_holder');
			$ppt = $('.ppt');
			var offsetY = ($('#header').height() - $('#auto-logout').height() + 30);
			$('div.pp_overlay').css({
				'height' : $(document).height() - offsetY,
				'margin-top' : offsetY
			});

			$ppt.css({
				'height' : offsetY,
				'width' : '100%',
				'position' : 'absolute',
				'top' : 0,
				'left' : 0
 			});
			
			$('a.pp_close').bind('click',function(){
              $.overlay.close();
              return false;
            });

			$pp_pic_holder.find('.pp_hoverContainer').css({
				'margin-left': 40/2
			});
            // Center overlay...
//            var overlay = $(this._target_holder);
//            overlay.css("top", ($(window).height() - overlay.height()) / 2 + $(window).scrollTop() + "px");
		}
	});
		
	$.fn.overlay = function(target_holder, conifirmTrue, conifirmFalse){
		var $holder = $(target_holder);

		if($holder.size() > 0) {
			$.overlay._fullsize = $holder.hasClass('fullsize');
			$.overlay._withImageAnimation = $holder.hasClass('animateImage');
			$.overlay._target_holder = target_holder;
			$.overlay._buildOverlay();
			$.overlay._attachListeners();
			$.overlay.show();

			
			if(typeof(conifirmTrue) == 'function') {
				$(target_holder).find('.conifirmTrue').die('click').live('click', function() {
					conifirmTrue(this);
				});
			}
			if(typeof(conifirmFalse) == 'function') {
				$(target_holder).find('.conifirmFalse').die('click').live('click', function() {
					conifirmFalse(this);
				});
			}
            return $.overlay;
		}
	};
	
	$.overlay = new Overlay(); // singleton instance
	
	//
	// plugin defaults
	//
	$.fn.overlay.defaults = {
		padding: 40
	};
})(jQuery);
