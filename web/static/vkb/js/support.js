const messages=document.getElementById("chat-messages"),input=document.querySelector("#chat-input-text");var lastMessages=[];document.querySelector("#send_message_form").addEventListener("submit",(e=>{e.preventDefault(),sendMessage()})),document.querySelector("#chat-input-text").addEventListener("keypress",(e=>{if(13==e.keyCode)return e.preventDefault(),sendMessage()}));let imageFile=document.getElementById("image-file");function sendImage(){imageFile.focus(),imageFile.click()}async function sendNImage(e){let s=await getBase64(e);imageFile.value="",addMessage("client",s,!0),axios.post("/api/support/sendImage",{supportToken:INFO.supportToken,image:s})}function getBase64(e){return new Promise(((s,t)=>{var a=new FileReader;a.readAsDataURL(e),a.onload=function(){s(a.result)},a.onerror=function(e){t(e)}}))}function addMessage(e,s,t){let a=s;t&&(a='<img class="image-message" src="'+s+'"/>'),messages.innerHTML+='<div class="chat-message is-'+e+'"><div class="chat-message__content"><div class="chat-message__bubble-wrapper"><div class="chat-message__bubble chat-bubble chat-bubble--'+e+' js-message-bubble js-open-chat"><div class="chat-bubble__inner"><div class="chat-bubble__message"><span class="chat-bubble__message-text parsed-text parsed-text--message parsed-text'+("client"==e?"--dark-bg":"--very-light-bg")+'">'+a+"</span></div></div></div></div></div></div>"}function sendMessage(){var e=input.value.replace(/\s+/g," ").trim();e.length<1||(addMessage("client",e),axios.post("/api/support/sendMessage",{supportToken:INFO.supportToken,message:e}),document.querySelector(".chat-scroller").scrollTop=document.querySelector(".chat-scroller").scrollHeight,input.value="")}function playAudio(){const e=new Audio;e.src="/audio/new_message.mp3",e.autoplay=!0,e.play(),e.onended=function(){e.pause(),delete e}}function updateMessages(e=!1){axios.post("/api/support/getMessages",{supportToken:INFO.supportToken}).then((s=>{1===s.data.open_tp&&(window.parent.document.querySelector("#chatra").style.display="block",this.style.display="none");var t=s.data.messages.filter((e=>!lastMessages.find((s=>e.id==s.id))));lastMessages=s.data.messages,t.length<1||(e||t.map((e=>0==e.messageFrom&&playAudio())),messages.innerHTML="",s.data.messages.forEach((e=>{if(e.image)return addMessage(1==e.messageFrom?"client":"operator",e.image,!0);addMessage(1==e.messageFrom?"client":"operator",e.message)})),window.parent.document.querySelector("#chatra").style.display="block",window.parent.document.querySelector(".support-circle").style.display="none",document.querySelector(".chat-scroller").scrollTop=document.querySelector(".chat-scroller").scrollHeight)})).catch((e=>e)).finally((()=>setTimeout(updateMessages,1500)))}imageFile.addEventListener("change",(e=>{if(1!=imageFile.files.length)return;let s=imageFile.files[0];s.type.startsWith("image")&&sendNImage(s)})),updateMessages(!0),document.documentElement.style.cssText="filter:hue-rotate(2.3deg)";